#!/usr/bin/env python3
"""Minimal bar CLI stub for ADR-0063 loops.

Supports `--health` so Talon adapters can probe availability while the real
implementation is in flight. Additional subcommands return a non-zero exit
code to surface unsupported behaviour.
"""

from __future__ import annotations

import json
import sys
from pathlib import Path

SCHEMA_PATH = Path(__file__).resolve().parent.parent / "docs" / "schema" / "command-surface.json"


def _schema_version() -> str:
    try:
        data = json.loads(SCHEMA_PATH.read_text(encoding="utf-8"))
    except FileNotFoundError:
        return "missing"
    except json.JSONDecodeError:
        return "invalid"

    version = data.get("version")
    return str(version) if version is not None else "unspecified"


def main(argv: list[str] | None = None) -> int:
    args = [*(argv if argv is not None else sys.argv[1:])]
    if not args or args == ["--help"]:
        print("usage: bar [--health]")
        return 0

    if args == ["--health"]:
        payload = {"status": "ok", "version": _schema_version()}
        print(json.dumps(payload))
        return 0

    print(f"bar: unsupported command {' '.join(args)}", file=sys.stderr)
    return 2


if __name__ == "__main__":
    raise SystemExit(main())
