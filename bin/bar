#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
GO_PACKAGE="${REPO_ROOT}/cmd/bar"
BIN_PATH="${SCRIPT_DIR}/bar.bin"
INSTALL_SCRIPT="${REPO_ROOT}/scripts/tools/install_bar_cli.py"

uname_os="$(uname -s | tr '[:upper:]' '[:lower:]')"
uname_arch="$(uname -m | tr '[:upper:]' '[:lower:]')"
case "${uname_arch}" in
  x86_64|amd64)
    uname_arch="amd64"
    ;;
  arm64|aarch64)
    uname_arch="arm64"
    ;;
esac
TARBALL_PATH="${REPO_ROOT}/artifacts/cli/bar-${uname_os}-${uname_arch}.tar.gz"
MANIFEST_PATH="${TARBALL_PATH}.sha256"
DELEGATION_STATE="${REPO_ROOT}/var/cli-telemetry/delegation-state.json"

if [[ -f "${DELEGATION_STATE}" ]] && command -v python3 >/dev/null 2>&1; then
  if disable_reason="$(python3 - "${DELEGATION_STATE}" <<'PY'
import json, sys
from pathlib import Path
path = Path(sys.argv[1])
try:
    payload = json.loads(path.read_text(encoding="utf-8"))
except Exception:
    sys.exit(1)
if payload.get("enabled", True):
    sys.exit(1)
print(payload.get("reason") or "CLI delegation disabled by Talon bootstrap")
sys.exit(0)
PY
  )"; then
    echo "bar: ${disable_reason}" >&2
    exit 65
  fi
fi

maybe_install_from_tarball() {
  if [[ ! -f "${INSTALL_SCRIPT}" ]]; then
    return 1
  fi
  if [[ ! -f "${TARBALL_PATH}" || ! -f "${MANIFEST_PATH}" ]]; then
    return 1
  fi
  if ! command -v python3 >/dev/null 2>&1; then
    echo "bar: python3 not available to install packaged CLI" >&2
    return 1
  fi
  if python3 "${INSTALL_SCRIPT}" --quiet; then
    return 0
  fi
  echo "bar: packaged CLI install failed; falling back to go build" >&2
  return 1
}

if [[ ! -x "${BIN_PATH}" ]]; then
  maybe_install_from_tarball || true
elif [[ -f "${MANIFEST_PATH}" && "${MANIFEST_PATH}" -nt "${BIN_PATH}" ]]; then
  maybe_install_from_tarball || true
fi

needs_build=0
if [[ ! -x "${BIN_PATH}" ]]; then
  needs_build=1
elif [[ "${REPO_ROOT}/go.mod" -nt "${BIN_PATH}" ]]; then
  needs_build=1
else
  latest_source="$(find "${GO_PACKAGE}" -type f -name '*.go' -newer "${BIN_PATH}" -print -quit 2>/dev/null || true)"
  if [[ -n "${latest_source}" ]]; then
    needs_build=1
  fi
fi

if [[ ${needs_build} -eq 1 ]]; then
  if ! command -v go >/dev/null 2>&1; then
    echo "bar: Go toolchain not available" >&2
    exit 1
  fi
  if [[ ! -d "${GO_PACKAGE}" ]]; then
    echo "bar: missing Go CLI source dir at ${GO_PACKAGE}" >&2
    exit 1
  fi
  GOFLAGS="${GOFLAGS:-}" go build -o "${BIN_PATH}" "${GO_PACKAGE}"
  chmod +x "${BIN_PATH}"
fi

BAR_ROOT="${REPO_ROOT}" exec "${BIN_PATH}" "$@"
