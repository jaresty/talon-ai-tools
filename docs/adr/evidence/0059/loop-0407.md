# loop-0407

- helper_version: helper:v20251223.1
- focus: ADR 0059 §Implementation Plan 4 — guard send_request refresh with destination/manual-close awareness
- riskiest_assumption: Avoiding `_refresh_response_canvas()` calls when the window was manually closed (or the destination is suggest/silent) will prevent surprise reopens without starving legitimate window runs; validated via new helper-level tests.
- validation_targets:
  - `python3 -m pytest _tests/test_model_helpers_response_canvas.py::ResponseCanvasRefreshTests::test_should_refresh_canvas_now_respects_manual_close`
  - `python3 -m pytest _tests/test_model_helpers_response_canvas.py::ResponseCanvasRefreshTests::test_should_refresh_canvas_now_follows_destination_kind`
  - `python3 -m pytest _tests/test_model_helpers_response_canvas.py`
- evidence:
  - red | 2025-12-23T22:57:10Z | exit 1 | `python3 -m pytest _tests/test_model_helpers_response_canvas.py::ResponseCanvasRefreshTests::test_should_refresh_canvas_now_respects_manual_close`
    - helper:diff-snapshot=0 files changed
    - pointer: inline — failure shows the helper function was missing, so manual-close scenarios still attempted to refresh the canvas.
  - green | 2025-12-23T22:59:30Z | exit 0 | `python3 -m pytest _tests/test_model_helpers_response_canvas.py`
    - helper:diff-snapshot=2 files changed, 28 insertions(+)
    - pointer: inline — new helper prevents refresh when manual close or suggest destination is active; streaming behaviour still passes existing tests.
- rollback_plan: `git restore --source=HEAD -- lib/modelHelpers.py _tests/test_model_helpers_response_canvas.py` && rerun the validation targets to re-trigger the earlier failure.
- delta_summary: helper:diff-snapshot=2 files changed, 28 insertions(+) — added `_should_refresh_canvas_now()` and regression tests covering manual-close/destination gating.
- residual_risks:
  - Risk: Other callers might bypass `_should_refresh_canvas_now()` and invoke `_refresh_response_canvas()` directly. Mitigation: audit remaining call sites while implementing Loop 5; Trigger: telemetry showing unexpected refreshes outside send_request.
- next_work:
  - Behaviour: add regression documentation/tests (Loop 5) — `python3 -m pytest _tests/test_model_helpers_response_canvas.py` / `_tests/test_model_response_canvas.py` with future-shaping notes.
