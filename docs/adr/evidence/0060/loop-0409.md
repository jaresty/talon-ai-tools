# loop-0409

- helper_version: helper:v20251223.1
- focus: ADR 0060 §Implementation Plan 1–2 — surface explicit `skip_history` plumbing for suggest flows
- riskiest_assumption: Passing an explicit `skip_history` flag through `PromptSession` into `send_request` prevents Silent destinations from logging history while keeping existing behaviour unchanged.
- validation_targets:
  - `python3 -m pytest _tests/test_gpt_actions.py::GPTActionPromptSessionTests::test_gpt_suggest_prompt_recipes_skips_history_append`
  - `python3 -m pytest _tests/test_suggest_parallel_requests.py`
  - `python3 -m pytest _tests/test_gpt_actions.py`
- evidence:
  - red | 2025-12-24T04:30:12Z | exit 1 | `python3 -m pytest _tests/test_gpt_actions.py::GPTActionPromptSessionTests::test_gpt_suggest_prompt_recipes_skips_history_append`
    - helper:diff-snapshot=0 files changed
    - pointer: inline — test failed with `AttributeError: module 'talon_user.lib.modelHelpers' has no attribute '_append_history_entry'`, demonstrating the missing explicit skip hook.
  - green | 2025-12-24T05:00:21Z | exit 0 | `python3 -m pytest _tests/test_gpt_actions.py::GPTActionPromptSessionTests::test_gpt_suggest_prompt_recipes_sets_skip_history_flag`
    - helper:diff-snapshot=5 files changed, 226 insertions(+), 54 deletions(-)
    - pointer: inline — suggest session marks `skip_history`, ensuring the request machinery sees the flag.
  - green | 2025-12-24T05:02:31Z | exit 0 | `python3 -m pytest _tests/test_suggest_parallel_requests.py`
    - helper:diff-snapshot=5 files changed, 226 insertions(+), 54 deletions(-)
    - pointer: inline — async fallback path still behaves, confirming mocks accept the new keyword.
  - green | 2025-12-24T05:05:59Z | exit 0 | `python3 -m pytest _tests/test_gpt_actions.py`
    - helper:diff-snapshot=5 files changed, 226 insertions(+), 54 deletions(-)
    - pointer: inline — entire GPT action suite passes with the new skip-history plumbing.
- rollback_plan: `git restore --source=HEAD -- GPT/gpt.py lib/modelHelpers.py lib/promptSession.py _tests/test_gpt_actions.py _tests/test_suggest_parallel_requests.py`
- delta_summary: helper:diff-snapshot=5 files changed, 226 insertions(+), 54 deletions(-) — added `_append_history_entry`, threaded `skip_history` through `PromptSession`/`send_request`, and updated suggest tests to assert the flag.
- residual_risks:
  - Risk: Other Silent destinations may still rely on implicit destination checks. Mitigation: audit remaining callers during loop-0410; Trigger: telemetry showing unexpected history entries for non-suggest Silent flows.
- next_work:
  - Behaviour: loop-0410 — add regression capturing missing-directional suggestions and telemetry guard (`python3 -m pytest _tests/test_gpt_actions.py::GPTActionPromptSessionTests::test_gpt_suggest_prompt_recipes_suppresses_history_on_missing_directional`).
