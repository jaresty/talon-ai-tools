- helper_version: helper:v20251223.1
- focus: ADR-0063 §Talon Adapter Layer (parse CLI JSON payloads on delegation)
- riskiest_assumption: Without parsing CLI responses, Talon cannot surface notify/debug messages from the bar binary (probability medium, impact medium-high on observability).
- validation_targets:
  - python3 - <<'PY'
      import os, sys
      from pathlib import Path
      from types import SimpleNamespace
      from unittest.mock import patch
      sys.path.insert(0, str(Path('.').resolve()))
      from bootstrap import bootstrap
      bootstrap()
      from talon_user.lib import providerCommands
      with (
          patch.object(providerCommands.settings, 'get', return_value=1),
          patch.object(providerCommands, '_bar_cli_command', return_value=Path('/tmp/bar')),
          patch.object(providerCommands.subprocess, 'run', return_value=SimpleNamespace(returncode=0, stdout='{"notify":"bar ok"}', stderr='')),
          patch.object(providerCommands, 'notify') as notify_mock,
      ):
          result = providerCommands._delegate_to_bar_cli('model_provider_use')
          if not result:
              raise SystemExit('delegation shim returned False despite JSON success')
      notify_mock.assert_called_once_with('bar ok')
      print('json payload parsed and notify invoked')
    PY
- evidence:
  - red | 2026-01-01T17:48:11Z | exit 1 | python3 - <<'PY'
      import subprocess
      content = subprocess.check_output(['git', 'show', 'HEAD~1:lib/providerCommands.py'], text=True)
      if 'json.loads' not in content:
          raise SystemExit('missing json payload handling in HEAD~1')
      print('json handling already present in HEAD~1')
    PY
    - helper:diff-snapshot=0 files changed
    - pointer: inline — prior revision lacked JSON parsing, command exits with failure.
  - green | 2026-01-01T17:50:02Z | exit 0 | python3 - <<'PY'
      import os, sys
      from pathlib import Path
      from types import SimpleNamespace
      from unittest.mock import patch
      sys.path.insert(0, str(Path('.').resolve()))
      from bootstrap import bootstrap
      bootstrap()
      from talon_user.lib import providerCommands
      with (
          patch.object(providerCommands.settings, 'get', return_value=1),
          patch.object(providerCommands, '_bar_cli_command', return_value=Path('/tmp/bar')),
          patch.object(providerCommands.subprocess, 'run', return_value=SimpleNamespace(returncode=0, stdout='{"notify":"bar ok"}', stderr='')),
          patch.object(providerCommands, 'notify') as notify_mock,
      ):
          result = providerCommands._delegate_to_bar_cli('model_provider_use')
          if not result:
              raise SystemExit('delegation shim returned False despite JSON success')
      notify_mock.assert_called_once_with('bar ok')
      print('json payload parsed and notify invoked')
    PY
    - helper:diff-snapshot=1 file changed, 30 insertions(+), 6 deletions(-)
    - pointer: inline — successful command shows JSON parsing and notification.
  - removal | 2026-01-01T17:48:35Z | exit 1 | python3 - <<'PY'
      import subprocess
      content = subprocess.check_output(['git', 'show', 'HEAD~1:lib/providerCommands.py'], text=True)
      if 'json.loads' not in content:
          raise SystemExit('json parsing absent after revert (expected removal)')
      print('json parsing still present in HEAD~1')
    PY
    - helper:diff-snapshot=0 files changed
    - pointer: inline — reverting (HEAD~1) removes JSON parsing, recreating the failure.
- rollback_plan: git checkout HEAD -- lib/providerCommands.py
- delta_summary: helper:diff-snapshot=1 file changed, 30 insertions(+), 6 deletions(-); `_delegate_to_bar_cli` now parses JSON output, forwarding CLI notifications to Talon.
- loops_remaining_forecast: 2 loops remaining (tests & documentation); confidence medium.
- residual_risks:
  - JSON schema is provisional; integration with telemetry/drop reasons still TODO.
- next_work:
  - Behaviour: extend CLI tests to cover JSON parsing — python3 -m pytest _tests/test_provider_commands.py — future-shaping: guard against regressions.
