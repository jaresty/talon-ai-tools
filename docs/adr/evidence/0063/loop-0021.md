# loop-0021 gate parity on packaged CLI artefacts

## metadata
- helper_version: helper:v20251223.1
- focus: Implementation Guardrails → Delivery posture — Salient task "Replace stubbed CLI delegation with real binary" (validation: `python3 -m pytest _tests/test_cli_talon_parity.py::CLITalonParityTests::test_packaged_cli_assets_present`).
- riskiest_assumption: Without a parity guardrail that fails when CLI artefacts are missing, Talon adapters could silently fall back to `go build`, eroding delivery posture and hiding release drift.
- validation_targets:
  - `python3 -m pytest _tests/test_cli_talon_parity.py::CLITalonParityTests::test_packaged_cli_assets_present`
- rollback_plan: `git restore --source=HEAD _tests/test_cli_talon_parity.py && python3 scripts/tools/package_bar_cli.py --print-paths`
- delta_summary: helper:diff-snapshot=1 file changed, 36 insertions(+), 1 deletion(-) — add parity test gating packaged CLI assets.
- loops_remaining_forecast:
  - 1 loop — Route bootstrap warning telemetry into Talon adapters and parity reporting (`python3 -m pytest _tests/test_cli_talon_parity.py`), confidence medium.
  - 2 loops — Publish signed CLI artefacts with CI enforcement and signature validation (`scripts/tools/check_cli_assets.py`), confidence medium.
- residual_risks:
  - Adapters still only warn via stderr (severity medium). Mitigation: integrate adapter telemetry next slice so parity runs capture missing artefacts even when bootstrap is skipped.
- next_work:
  - Behaviour: Replace stubbed CLI delegation with real binary — propagate bootstrap warnings into Talon adapters and parity harness via `python3 -m pytest _tests/test_cli_talon_parity.py`.
  - Behaviour: Release checksum manifest hardening — incorporate signature validation into `scripts/tools/check_cli_assets.py`.

## loop-0021 red | helper:rerun python3 -m pytest _tests/test_cli_talon_parity.py
- 2026-01-02T21:33:45Z | exit 0
- helper:diff-snapshot=0 files changed
- failure: parity harness stayed green with packaged CLI manifest removed | inline

```
============================= test session starts ==============================
platform darwin -- Python 3.11.14, pytest-8.2.1, pluggy-1.6.0
rootdir: /Users/tkma6d4/.talon/user/talon-ai-tools
configfile: pyproject.toml
collected 2 items

_tests/test_cli_talon_parity.py ..                                       [100%]

============================== 2 passed in 0.56s ===============================
```

## loop-0021 green | helper:rerun python3 -m pytest _tests/test_cli_talon_parity.py::CLITalonParityTests::test_packaged_cli_assets_present
- 2026-01-02T21:40:03Z | exit 1
- helper:diff-snapshot=1 file changed, 36 insertions(+), 1 deletion(-)
- success: parity guardrail fails fast with remediation instructions when artefacts missing | inline

```
============================= test session starts ==============================
platform darwin -- Python 3.11.14, pytest-8.2.1, pluggy-1.6.0
rootdir: /Users/tkma6d4/.talon/user/talon-ai-tools
configfile: pyproject.toml
collected 1 item

_tests/test_cli_talon_parity.py F                                        [100%]

________________ CLITalonParityTests.test_packaged_cli_assets_present __________________

self = <_tests.test_cli_talon_parity.CLITalonParityTests testMethod=test_packaged_cli_assets_present>

    def test_packaged_cli_assets_present(self) -> None:
        tarball = _packaged_cli_tarball()
        manifest = _packaged_cli_manifest(tarball)
    
        missing = [str(path) for path in (tarball, manifest) if not path.exists()]
        if missing:
>           self.fail(
                "Packaged CLI artefacts missing; run `python3 scripts/tools/package_bar_cli.py --print-paths` "
                f"to rebuild. Missing: {', '.join(missing)}"
            )
E           AssertionError: Packaged CLI artefacts missing; run `python3 scripts/tools/package_bar_cli.py --print-paths` to rebuild. Missing: artifacts/cli/bar-darwin-arm64.tar.gz.sha256

=========================== short test summary info ============================
FAILED _tests/test_cli_talon_parity.py::CLITalonParityTests::test_packaged_cli_assets_present
============================== 1 failed in 0.03s ===============================
```

## loop-0021 removal | helper:rerun python3 -m pytest _tests/test_cli_talon_parity.py
- 2026-01-02T21:43:57Z | exit 0
- helper:diff-snapshot=0 files changed
- failure returns when parity guardrail removed | inline

```
============================= test session starts ==============================
platform darwin -- Python 3.11.14, pytest-8.2.1, pluggy-1.6.0
rootdir: /Users/tkma6d4/.talon/user/talon-ai-tools
configfile: pyproject.toml
collected 2 items

_tests/test_cli_talon_parity.py ..                                       [100%]

============================== 2 passed in 0.06s ===============================
```
