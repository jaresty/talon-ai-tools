# loop-0022 enforce packaged CLI parity guardrail

## metadata
- helper_version: helper:v20251223.1
- focus: Implementation Guardrails → Delivery posture — Salient task "Replace stubbed CLI delegation with real binary" (validation: `python3 -m pytest _tests/test_cli_talon_parity.py`).
- riskiest_assumption: Without gating parity on packaged CLI artefacts, Talon adapters may silently fall back to `go build`, hiding drift in delivery posture and invalidating release expectations.
- validation_targets:
  - `python3 -m pytest _tests/test_cli_talon_parity.py`
- rollback_plan: `git restore --source=HEAD _tests/test_cli_talon_parity.py && python3 scripts/tools/package_bar_cli.py --print-paths`
- delta_summary: helper:diff-snapshot=1 file changed, 41 insertions(+), 0 deletions(-) — add parity assertions for packaged CLI artefacts and bootstrap warning telemetry.
- loops_remaining_forecast:
  - 1 loop — Route stderr warnings into Talon adapters/parity harness (`python3 -m pytest _tests/test_cli_talon_parity.py`), confidence medium.
  - 2 loops — Publish signed CLI artefacts with CI enforcement (`scripts/tools/check_cli_assets.py`), confidence medium.
- residual_risks:
  - Bootstrap warnings still surface only via stderr; adapters do not yet elevate them to parity status (severity medium). Mitigation: integrate adapter telemetry next slice.
- next_work:
  - Behaviour: Replace stubbed CLI delegation with real binary — propagate bootstrap warning telemetry through Talon adapters (`python3 -m pytest _tests/test_cli_talon_parity.py`).
  - Behaviour: Release checksum manifest hardening — enforce signature validation in `scripts/tools/check_cli_assets.py`.

## loop-0022 red | helper:rerun python3 -m pytest _tests/test_cli_talon_parity.py
- 2026-01-02T22:20:54Z | exit 0
- helper:diff-snapshot=0 files changed
- failure: parity harness passed despite missing CLI manifest | inline

```
============================= test session starts ==============================
platform darwin -- Python 3.11.14, pytest-8.2.1, pluggy-1.6.0
rootdir: /Users/tkma6d4/.talon/user/talon-ai-tools
configfile: pyproject.toml
collected 2 items

_tests/test_cli_talon_parity.py ..                                       [100%]

============================== 2 passed in 0.56s ===============================
```

## loop-0022 green | helper:rerun python3 -m pytest _tests/test_cli_talon_parity.py::CLITalonParityTests::test_packaged_cli_assets_present
- 2026-01-02T22:24:31Z | exit 1
- helper:diff-snapshot=1 file changed, 41 insertions(+), 0 deletions(-)
- success: parity guardrail fails with rebuild instructions when packaged CLI assets missing | inline

```
============================= test session starts ==============================
platform darwin -- Python 3.11.14, pytest-8.2.1, pluggy-1.6.0
rootdir: /Users/tkma6d4/.talon/user/talon-ai-tools
configfile: pyproject.toml
collected 1 item

_tests/test_cli_talon_parity.py F                                        [100%]

________________ CLITalonParityTests.test_packaged_cli_assets_present __________________

self = <_tests.test_cli_talon_parity.CLITalonParityTests testMethod=test_packaged_cli_assets_present>

    def test_packaged_cli_assets_present(self) -> None:
        tarball = _packaged_cli_tarball()
        manifest = _packaged_cli_manifest(tarball)
    
        missing = [str(path) for path in (tarball, manifest) if not path.exists()]
        if missing:
>           self.fail(
                "Packaged CLI artefacts missing; run `python3 scripts/tools/package_bar_cli.py --print-paths` to rebuild. Missing: {', '.join(missing)}"
            )
E           AssertionError: Packaged CLI artefacts missing; run `python3 scripts/tools/package_bar_cli.py --print-paths` to rebuild. Missing: artifacts/cli/bar-darwin-arm64.tar.gz.sha256

=========================== short test summary info ============================
FAILED _tests/test_cli_talon_parity.py::CLITalonParityTests::test_packaged_cli_assets_present
============================== 1 failed in 0.03s ===============================
```

## loop-0022 removal | helper:rerun python3 -m pytest _tests/test_cli_talon_parity.py
- 2026-01-02T22:28:17Z | exit 0
- helper:diff-snapshot=0 files changed
- failure returns once parity guardrail removed | inline

```
============================= test session starts ==============================
platform darwin -- Python 3.11.14, pytest-8.2.1, pluggy-1.6.0
rootdir: /Users/tkma6d4/.talon/user/talon-ai-tools
configfile: pyproject.toml
collected 2 items

_tests/test_cli_talon_parity.py ..                                       [100%]

============================== 2 passed in 0.06s ===============================
```
