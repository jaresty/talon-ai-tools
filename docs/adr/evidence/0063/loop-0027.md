# loop-0027 gate delegation with CLI health probe

## metadata
- helper_version: helper:v20251223.1
- focus: Implementation Guardrails → Delivery posture — Salient task "Replace stubbed CLI delegation with real binary" (validation: `python3 -m pytest _tests/test_cli_talon_parity.py`).
- riskiest_assumption: Without tying Talon’s delegation state to the CLI health probe, operators could continue delegating to a broken or missing binary after bootstrap, violating the delivery posture guarantees.
- validation_targets:
  - `python3 -m pytest _tests/test_cli_talon_parity.py`
- rollback_plan: `git restore --source=HEAD bootstrap.py _tests/test_cli_talon_parity.py lib/cliDelegation.py lib/cliHealth.py docs/adr/0063-go-cli-single-source-of-truth.work-log.md docs/adr/evidence/0063/loop-0027.md`
- delta_summary: helper:diff-snapshot=6 files changed, 238 insertions(+), 9 deletions(-)
- loops_remaining_forecast:
  - 1 loop — Feed delegation failure counters into Talon adapter fallback/backoff UX (`python3 -m pytest _tests/test_cli_talon_parity.py`), confidence medium.
  - 2 loops — Wire packaged asset/signed bundle checks into CI using delegation telemetry (`scripts/tools/check_cli_assets.py`), confidence medium.
- residual_risks:
  - Health probe still runs on demand; adapters must invoke it at startup to benefit from telemetry (severity medium). Mitigation: upcoming adapter integration slice; monitor parity tests for regressions.
- next_work:
  - Behaviour: Replace stubbed CLI with real delegation adapter — consume `cliHealth` telemetry inside adapters to trigger automatic fallback (`python3 -m pytest _tests/test_cli_talon_parity.py`).
  - Behaviour: Harden release pipeline with checksum manifest — extend CI guardrail to fail when delegation state reports missing artefacts (`scripts/tools/check_cli_assets.py`).

## loop-0027 red | helper:rerun python3 -m pytest _tests/test_cli_talon_parity.py::CLITalonParityTests::test_cli_health_probe_trips_delegation_after_failures
- 2026-01-03T01:49:27Z | exit 2
- helper:diff-snapshot=0 files changed
- failure: test import fails because `lib.cliHealth` module is absent, demonstrating missing health/telemetry integration | inline

```
ModuleNotFoundError: No module named 'lib.cliHealth'
```

## loop-0027 green | helper:rerun python3 -m pytest _tests/test_cli_talon_parity.py
- 2026-01-03T01:50:19Z | exit 0
- helper:diff-snapshot=4 files changed, 138 insertions(+), 9 deletions(-)
- success: parity harness passes, including new health-probe test ensuring delegation disables after repeated failures and re-enables after recovery | inline

```
_tests/test_cli_talon_parity.py .....                                    [100%]
```

## loop-0027 removal | helper:rerun python3 -m pytest _tests/test_cli_talon_parity.py::CLITalonParityTests::test_cli_health_probe_trips_delegation_after_failures
- 2026-01-03T01:51:28Z | exit 2
- helper:diff-snapshot=0 files changed
- failure returns when health module is removed, reestablishing the ModuleNotFoundError guardrail | inline

```
ModuleNotFoundError: No module named 'lib.cliHealth'
```
