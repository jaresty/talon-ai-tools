# loop-0028 gate request starts on CLI health failures

## metadata
- helper_version: helper:v20251223.1
- focus: Implementation Guardrails → Delivery posture — enforce request gating against unhealthy CLI delegation (validation: `python3 -m pytest _tests/test_cli_talon_parity.py`).
- riskiest_assumption: Request gating would continue launching CLI-backed requests even after the health probe disabled delegation, hiding broken artefacts behind the legacy fallback.
- validation_targets:
  - `python3 -m pytest _tests/test_cli_talon_parity.py`
- rollback_plan: `git restore --source=HEAD _tests/test_cli_talon_parity.py lib/cliDelegation.py lib/requestGating.py lib/requestLog.py lib/requestState.py` then rerun the red parity test to confirm the guard fails again.
- delta_summary: helper:diff-snapshot=6 files changed, 117 insertions(+), 3 deletions(-) — add CLI gating helper, extend drop-reason catalog, and assert the behaviour in parity tests.
- loops_remaining_forecast:
  - 1 loop — Surface health/failure telemetry inside Talon adapter UI/backoff workflows (`python3 -m pytest _tests/test_cli_talon_parity.py`), confidence medium.
  - 2 loops — Wire delegation telemetry into release/asset verification (`scripts/tools/check_cli_assets.py`), confidence medium.
- residual_risks:
  - Delegation disablement is still only visible via notifications/logs; adapter UI/backoff wiring remains pending (severity medium). Monitor parity tests and adapter stories for regressions until the next slice lands.
- next_work:
  - Behaviour: Replace stubbed CLI delegation with real binary — integrate failure counts into adapter backoff and UI affordances (`python3 -m pytest _tests/test_cli_talon_parity.py`).
  - Behaviour: Harden release pipeline with checksum manifest — consume delegation telemetry inside release guardrails (`scripts/tools/check_cli_assets.py`).

## loop-0028 red | helper:rerun python3 -m pytest _tests/test_cli_talon_parity.py::CLITalonParityTests::test_request_gating_blocks_when_cli_unhealthy
- 2026-01-03T02:24:10Z | exit 1
- helper:diff-snapshot=1 file changed, 31 insertions(+)
- failure: parity harness allowed request gating to proceed even though delegation was disabled by the health probe | inline

```
>       self.assertFalse(allowed)
E       AssertionError: True is not false

_tests/test_cli_talon_parity.py:338: AssertionError
```

## loop-0028 green | helper:rerun python3 -m pytest _tests/test_cli_talon_parity.py
- 2026-01-03T02:22:52Z | exit 0
- helper:diff-snapshot=6 files changed, 117 insertions(+), 3 deletions(-)
- success: parity suite passes with CLI delegation gating unhealthy states and telemetry recorded | inline

```
_tests/test_cli_talon_parity.py ......                                   [100%]
```

## loop-0028 removal | helper:rerun python3 -m pytest _tests/test_cli_talon_parity.py::CLITalonParityTests::test_request_gating_blocks_when_cli_unhealthy
- 2026-01-03T02:24:10Z | exit 1
- helper:diff-snapshot=1 file changed, 31 insertions(+)
- failure returns after restoring pre-loop code, confirming the guard enforces the behaviour | inline

```
>       self.assertFalse(allowed)
E       AssertionError: True is not false

_tests/test_cli_talon_parity.py:338: AssertionError
```
