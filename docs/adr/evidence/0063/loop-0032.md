# loop-0032 enforce delegation snapshot digests in release guardrails

## metadata
- helper_version: helper:v20251223.1
- focus: Implementation Guardrails → Delivery posture — enforce delegation snapshot digest verification in release guard (`python3 scripts/tools/check_cli_assets.py`).
- riskiest_assumption: Without hashing the delegation snapshot, releases could ship with stale or tampered delegation state while the asset guard stays green, allowing Talon to delegate to an unhealthy CLI binary.
- validation_targets:
  - `python3 scripts/tools/check_cli_assets.py`
- rollback_plan: `git restore --source=HEAD _tests/test_check_cli_assets.py scripts/tools/check_cli_assets.py scripts/tools/package_bar_cli.py docs/adr/0063-go-cli-single-source-of-truth.work-log.md && python3 scripts/tools/check_cli_assets.py`
- delta_summary: helper:diff-snapshot=4 files changed, 270 insertions(+), 7 deletions(-) — added canonical snapshot digests, updated release packaging, expanded guard tests, and refreshed work-log scope.
- loops_remaining_forecast:
  - 1 loop — Publish digest artefacts through CI release uploads and signature signing (`scripts/tools/check_cli_assets.py`), confidence medium.
  - 2 loops — Wire Talon bootstrap to preload signed snapshot bundles before delegation (`python3 -m pytest _tests/test_cli_talon_parity.py`), confidence medium.
- residual_risks:
  - Snapshot generation still relies on local packaging runs; CI enforcement and signed upload contracts remain outstanding (severity medium). Mitigation: next slice stitches digest manifests into CI release workflow and monitors guardrail failures in automation logs.
- next_work:
  - Behaviour: Replace stubbed CLI delegation with real binary — ensure bootstrap installs hashed snapshot bundles before enabling delegation (`python3 scripts/tools/check_cli_assets.py`).
  - Behaviour: Harden release pipeline with checksum manifest — integrate digest manifest signing and CI publication (`python3 scripts/tools/check_cli_assets.py`).

## loop-0032 red | helper:rerun python3 scripts/tools/check_cli_assets.py
- 2026-01-03T03:48:19.214070+00:00 | exit 1
- helper:diff-snapshot=0 files changed
- failure: release guard refused to pass without a delegation snapshot digest manifest | inline

```
missing delegation state digest: artifacts/cli/delegation-state.json.sha256
```

## loop-0032 green | helper:rerun python3 scripts/tools/check_cli_assets.py
- 2026-01-03T03:48:26.526591+00:00 | exit 0
- helper:diff-snapshot=4 files changed, 270 insertions(+), 7 deletions(-)
- success: release guard passes once the snapshot digest manifest is present and matches the canonical state | inline

```
all CLI assets present
```

## loop-0032 removal | helper:rerun rm artifacts/cli/delegation-state.json.sha256 && python3 scripts/tools/check_cli_assets.py
- 2026-01-03T03:48:49.811755+00:00 | exit 1
- helper:diff-snapshot=0 files changed
- failure returns when the digest manifest is removed, confirming the guardrail blocks unsigned delegation snapshots | inline

```
missing delegation state digest: artifacts/cli/delegation-state.json.sha256
```
