# loop-0034 surface snapshot digest failures before parity runs

## metadata
- helper_version: helper:v20251223.1
- focus: Implementation Guardrails → Delivery posture — surface bootstrap failure when delegation snapshot hashes drift (`python3 - <<'PY' ... bootstrap.bootstrap() ...`).
- riskiest_assumption: If bootstrap silently falls back after snapshot drift, parity tests run against stale delegation metadata and releases can pass while Talon disables delegation at runtime.
- validation_targets:
  - `python3 - <<'PY'
import pathlib, sys
bin_path = pathlib.Path('bin/bar.bin')
if bin_path.exists():
    bin_path.unlink()
import bootstrap
bootstrap.bootstrap()
if bin_path.exists():
    sys.exit(0)
raise SystemExit('bootstrap did not install CLI binary')
PY`
- rollback_plan: `git restore --source=HEAD bootstrap.py scripts/tools/install_bar_cli.py _tests/test_cli_talon_parity.py docs/adr/0063-go-cli-single-source-of-truth.work-log.md && rm docs/adr/evidence/0063/loop-0034.md`
- delta_summary: helper:diff-snapshot=4 files changed, 91 insertions(+), 12 deletions(-) — add snapshot exception plumbing, raise bootstrap guardrails, extend parity tests, and refresh work-log.
- loops_remaining_forecast:
  - 1 loop — Enforce snapshot signature verification before parity (`python3 scripts/tools/check_cli_assets.py`), confidence medium.
  - 2 loops — Wire CI release upload to sign and publish snapshot manifests (`python3 scripts/tools/check_cli_assets.py`), confidence medium.
- residual_risks:
  - Snapshot signature enforcement is still manual (severity medium). Mitigation: next slice adds signature verification and records telemetry before allowing bootstrap to continue.
- next_work:
  - Behaviour: Harden release pipeline with checksum manifest — add signature generation and CI verification for snapshot artefacts (`python3 scripts/tools/check_cli_assets.py`).
  - Behaviour: Replace stubbed CLI delegation with real binary — block parity enablement until snapshot signatures verify green in bootstrap (`python3 - <<'PY' ... bootstrap.bootstrap() ...`).

## loop-0034 red | helper:rerun python3 - <<'PY' ...
- 2026-01-03T05:21:38Z | exit 1
- helper:diff-snapshot=0 files changed
- failure: bootstrap aborts with delegation snapshot digest mismatch after manifest tampering | inline

```
bootstrap: delegation snapshot validation failed; run `python3 scripts/tools/package_bar_cli.py --print-paths` to rebuild packaged CLI: delegation snapshot digest mismatch: expected 0000000000000000000000000000000000000000000000000000000000000000, got fea436d14613739a8148d9809126834ee892c9b4d8df32b0701f04e98f863ab5
scripts.tools.install_bar_cli.DelegationSnapshotError: delegation snapshot digest mismatch: expected 0000000000000000000000000000000000000000000000000000000000000000, got fea436d14613739a8148d9809126834ee892c9b4d8df32b0701f04e98f863ab5
```

## loop-0034 green | helper:rerun python3 - <<'PY' ...
- 2026-01-03T05:22:22Z | exit 0
- helper:diff-snapshot=3 files changed, 156 insertions(+), 5 deletions(-)
- success: bootstrap installs CLI once hashes match release snapshot and hydrates runtime state | inline

```
(no stderr output)
```

## loop-0034 removal | helper:rerun python3 - <<'PY' ...
- 2026-01-03T05:22:48Z | exit 1
- helper:diff-snapshot=0 files changed
- failure returns when snapshot manifest is corrupted again, keeping bootstrap blocked ahead of parity | inline

```
bootstrap: delegation snapshot validation failed; run `python3 scripts/tools/package_bar_cli.py --print-paths` to rebuild packaged CLI: delegation snapshot digest mismatch: expected 1111111111111111111111111111111111111111111111111111111111111111, got fea436d14613739a8148d9809126834ee892c9b4d8df32b0701f04e98f863ab5
scripts.tools.install_bar_cli.DelegationSnapshotError: delegation snapshot digest mismatch: expected 1111111111111111111111111111111111111111111111111111111111111111, got fea436d14613739a8148d9809126834ee892c9b4d8df32b0701f04e98f863ab5
```
