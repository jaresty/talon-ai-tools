#!/usr/bin/expect -f
set timeout 30
set env(NO_COLOR) 1
set transcript $env(TUI_EXPECT_TRANSCRIPT)
log_file -a $transcript
set cmd [split $env(TUI_EXPECT_CMD)]
eval spawn $cmd

expect {
    -re {bar prompt editor \(Bubble Tea prototype\)} {}
    timeout { send_error "failed to render header"; exit 1 }
}

send "\u0010" ;# Ctrl+P opens palette
expect {
    -re {Token palette open\. Type to filter \(try "copy command"\), Tab cycles focus, Enter applies or copies, Ctrl\+W clears the filter, Esc closes\.} {}
    timeout { send_error "expected palette open status"; exit 1 }
}

send "todo"
expect {
    -re {Token palette open \(filter="todo"\)\. Enter applies or copies; type "copy command" to focus the copy action\. Tab cycles focus, Ctrl\+W clears the filter, Esc closes\.} {}
    timeout { send_error "expected filtered status"; exit 1 }
}

send "\r"
expect {
    -re {Static Prompt → todo \(Return a todo list\)\. Press Enter to toggle, Ctrl\+W clears the filter, Esc closes\. Type "copy command" to focus the copy action\.} {}
    timeout { send_error "expected palette option focus status"; exit 1 }
}

send "\r"
expect {
    -re {Static Prompt → todo applied\.} {}
    timeout { send_error "expected token applied status"; exit 1 }
}

send "\u0008" ;# Ctrl+H toggles history (backspace code point)
expect {
    -re {History expanded\. Press Ctrl\+H to collapse\.} {}
    timeout { send_error "missing history toggle status"; exit 1 }
}
expect {
    -re {• \[[0-9]{2}:[0-9]{2}\] .*Tokens ·} {}
    timeout { send_error "missing history metadata"; exit 1 }
}
expect {
    -re {Prompt → todo applied} {}
    timeout { send_error "missing history message"; exit 1 }
}

send "\003"
after 200
send "\003"
expect eof
