#!/usr/bin/expect -f
set timeout 30
set env(NO_COLOR) 1
set transcript $env(TUI_EXPECT_TRANSCRIPT)
log_file -a $transcript
set cmd [split $env(TUI_EXPECT_CMD)]
eval spawn $cmd

expect {
    -re {bar prompt editor \(Bubble Tea prototype\)} {}
    timeout { send_error "failed to render header"; exit 1 }
}

send "\u0010" ;# Ctrl+P opens palette
expect {
    -re {bar build.*Tab.*cycle.*copy command} {}
    timeout { send_error "expected palette open status with CLI command input"; exit 1 }
}

# Type "infer" to filter to that specific token
send "infer"
expect {
    -re {bar build.*infer} {}
    timeout { send_error "expected filter to show infer"; exit 1 }
}

# Enter to navigate to matching option
send "\r"
expect {
    -re {infer.*toggle} {}
    timeout { send_error "expected token option status"; exit 1 }
}

# Enter to apply the token
send "\r"
expect {
    -re {infer applied} {}
    timeout { send_error "expected token applied status"; exit 1 }
}

send "\u0008" ;# Ctrl+H toggles history (backspace code point)
expect {
    -re {History expanded\. Press Ctrl\+H to collapse\. Press Ctrl\+Shift\+H to copy the latest CLI command\.} {}
    timeout { send_error "missing history toggle status"; exit 1 }
}
expect {
    -re {\[[0-9]{2}:[0-9]{2}\].*Tokens} {}
    timeout { send_error "missing history metadata"; exit 1 }
}

send "\003"
after 200
send "\003"
expect eof
